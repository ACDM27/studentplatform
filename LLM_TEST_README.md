# LLM Connection Test Tool 使用指南

## 简介

这是一个用于测试和诊断大语言模型API连接问题的Python工具。它可以帮助你快速定位AI聊天功能的问题所在。

## 功能特性

✅ **服务器连通性测试** - 验证后端服务器是否可访问  
✅ **端点存在性检查** - 确认API端点是否正确配置  
✅ **JWT认证验证** - 测试token是否有效  
✅ **请求格式测试** - 自动测试多种请求格式  
✅ **响应结构验证** - 检查响应数据是否正确  
✅ **详细错误报告** - 提供具体的错误原因和修复建议  

## 安装依赖

```bash
pip install -r requirements-test.txt
```

或者直接安装：

```bash
pip install requests
```

## 使用方法

### 基本用法

```bash
python test_llm_connection.py --url http://localhost:1337 --student-id 123
```

### 带JWT认证

```bash
python test_llm_connection.py --url http://localhost:1337 --token "你的JWT_TOKEN" --student-id 123
```

### 详细模式（显示完整的请求和响应）

```bash
python test_llm_connection.py --url http://localhost:1337 --student-id 123 --verbose
```

### 自定义测试问题

```bash
python test_llm_connection.py --url http://localhost:1337 --student-id 123 --question "根据我的兴趣推荐课程"
```

## 参数说明

| 参数 | 必需 | 说明 | 示例 |
|------|------|------|------|
| `--url` | 是 | 后端服务器URL | `http://localhost:1337` |
| `--token` | 否 | JWT认证token | `eyJhbGc...` |
| `--student-id` | 否 | 学生ID（默认123） | `456` |
| `--question` | 否 | 测试问题 | `请分析我的学习数据` |
| `--verbose` / `-v` | 否 | 显示详细日志 | - |

## 测试项目

工具会执行以下测试：

1. **服务器连通性** - 检查后端服务器是否在线
2. **端点存在性** - 验证 `/api/student-portraits/chat` 端点是否存在
3. **JWT认证** - 测试token是否有效（如果提供）
4. **Direct格式请求** - 测试直接格式的请求
5. **Wrapped格式请求** - 测试Strapi v5风格的包装格式
6. **响应结构验证** - 检查响应数据的字段和格式

## 输出示例

```
==================================================================
          LLM Connection Test Tool v1.0                       
==================================================================

配置信息:
  后端URL: http://localhost:1337
  API端点: http://localhost:1337/api/student-portraits/chat
  学生ID: 123
  Token: 已提供
  详细模式: 关闭

[1/6] 测试服务器连通性
----------------------------------------------------------------------
  ✓ 服务器可达 (响应时间: 45ms, 状态码: 200)

[2/6] 测试端点存在性
----------------------------------------------------------------------
  ✓ 端点存在 (状态码: 400)

[3/6] 测试认证
----------------------------------------------------------------------
  ✓ 认证成功 (用户: student123)

[4-5/6] 测试请求格式
----------------------------------------------------------------------
  ✓ Direct格式被接受 (耗时: 1.2s)
  ✗ Wrapped格式被拒绝 (状态码: 400)

[6/6] 验证响应结构
----------------------------------------------------------------------
  ✓ 找到响应字段: response, timestamp

==================================================================
                    测试报告                              
==================================================================

总测试数: 6
通过: 5
失败: 1
警告: 0

诊断建议
----------------------------------------------------------------------

✓ 找到可用的请求格式
  推荐使用: DIRECT 格式
  前端代码示例:
    const data = {
      question: userQuestion,
      student_id: studentId
    }

✓ 响应结构验证通过
  可用的响应字段: response, timestamp
  前端代码建议:
    const aiMessage = response.response

总结
----------------------------------------------------------------------
⚠ 部分测试失败，但基本功能可用
  请根据上述建议进行修复
```

## 常见问题

### 1. 连接超时

**错误**: `连接超时 (>10秒)`

**解决方案**:
- 检查后端服务是否正在运行
- 验证URL是否正确
- 检查防火墙设置

### 2. 端点不存在 (404)

**错误**: `端点不存在 (404)`

**解决方案**:
- 检查后端路由配置
- 确认 `/api/student-portraits/chat` 路由已注册
- 查看后端日志

### 3. 认证失败 (401)

**错误**: `Token无效或已过期 (401)`

**解决方案**:
- 重新登录获取新token
- 检查token格式是否正确
- 验证用户权限

### 4. 请求格式错误 (400)

**错误**: `请求格式被拒绝 (状态码: 400)`

**解决方案**:
- 使用工具推荐的格式
- 检查后端API文档
- 查看详细错误信息（使用 `--verbose`）

## 获取JWT Token

如果需要JWT token进行测试，可以：

1. 在浏览器中登录系统
2. 打开开发者工具 (F12)
3. 查看 Application > Local Storage
4. 找到 `jwt` 或 `token` 字段
5. 复制token值

或者使用登录API获取：

```bash
curl -X POST http://localhost:1337/api/auth/local \
  -H "Content-Type: application/json" \
  -d '{"identifier":"your_username","password":"your_password"}'
```

## 故障排查流程

1. **运行基本测试**
   ```bash
   python test_llm_connection.py --url http://localhost:1337 --student-id 123
   ```

2. **如果服务器连接失败**
   - 检查后端是否运行: `curl http://localhost:1337`
   - 检查端口是否正确
   - 检查防火墙设置

3. **如果端点不存在**
   - 查看后端路由配置文件
   - 检查后端日志
   - 确认API版本

4. **如果请求格式错误**
   - 使用 `--verbose` 查看详细信息
   - 根据工具建议修改前端代码
   - 查看后端API文档

5. **如果响应格式不对**
   - 检查后端返回的字段名
   - 修改前端解析逻辑
   - 联系后端开发者

## 技术支持

如果问题仍然存在，请提供：
- 完整的测试输出
- 后端服务器日志
- 使用 `--verbose` 模式的详细输出

## 许可证

MIT License
