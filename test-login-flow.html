<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•æµç¨‹æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e6f7ff;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            background: #fff1f0;
            color: #cf1322;
        }
        .success {
            background: #f6ffed;
            color: #52c41a;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç™»å½•æµç¨‹æµ‹è¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>1. æµ‹è¯•åç«¯ API è¿æ¥</h3>
            <label>API åœ°å€:</label>
            <input type="text" id="apiUrl" value="http://localhost:1337/api/auth/local">
            <label>ç”¨æˆ·å/å­¦å·:</label>
            <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–å­¦å·">
            <label>å¯†ç :</label>
            <input type="password" id="password" placeholder="è¾“å…¥å¯†ç ">
            <button onclick="testLogin()">æµ‹è¯•ç™»å½• API</button>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. æ£€æŸ¥ localStorage</h3>
            <button onclick="checkLocalStorage()">æ£€æŸ¥ Token</button>
            <button onclick="clearLocalStorage()">æ¸…é™¤ Token</button>
            <button onclick="setTestToken()">è®¾ç½®æµ‹è¯• Token</button>
            <div id="storageResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•è·¯ç”±è·³è½¬</h3>
            <button onclick="testRouteNavigation()">æµ‹è¯•è·³è½¬åˆ° Dashboard</button>
            <button onclick="testDirectAccess()">ç›´æ¥è®¿é—® Dashboard</button>
            <div id="routeResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. è¯Šæ–­ä¿¡æ¯</h3>
            <button onclick="showDiagnostics()">æ˜¾ç¤ºå®Œæ•´è¯Šæ–­</button>
            <div id="diagnosticsResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç™»å½• API
        async function testLogin() {
            const apiUrl = document.getElementById('apiUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            if (!username || !password) {
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•ç™»å½•...';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identifier: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.jwt) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ç™»å½•æˆåŠŸï¼\n\nToken: ${data.jwt.substring(0, 50)}...\n\nç”¨æˆ·ä¿¡æ¯:\n${JSON.stringify(data.user, null, 2)}`;
                    
                    // è‡ªåŠ¨ä¿å­˜ token
                    localStorage.setItem('token', data.jwt);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ç™»å½•å¤±è´¥\n\nçŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ è¯·æ±‚å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nè¯·ç¡®è®¤:\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:1337\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. CORS é…ç½®æ˜¯å¦æ­£ç¡®`;
            }
        }

        // æ£€æŸ¥ localStorage
        function checkLocalStorage() {
            const resultDiv = document.getElementById('storageResult');
            resultDiv.style.display = 'block';
            
            const token = localStorage.getItem('token');
            
            if (token) {
                resultDiv.className = 'result success';
                resultDiv.textContent = `âœ… Token å­˜åœ¨\n\n${token.substring(0, 100)}...\n\né•¿åº¦: ${token.length} å­—ç¬¦`;
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ æœªæ‰¾åˆ° Token\n\nè¯·å…ˆç™»å½•æˆ–è®¾ç½®æµ‹è¯• Token';
            }
        }

        // æ¸…é™¤ localStorage
        function clearLocalStorage() {
            localStorage.removeItem('token');
            localStorage.removeItem('savedStudentId');
            localStorage.removeItem('savedPassword');
            localStorage.removeItem('rememberPassword');
            
            const resultDiv = document.getElementById('storageResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.textContent = 'âœ… å·²æ¸…é™¤æ‰€æœ‰ç™»å½•ä¿¡æ¯';
        }

        // è®¾ç½®æµ‹è¯• Token
        function setTestToken() {
            const testToken = 'test-token-' + Date.now();
            localStorage.setItem('token', testToken);
            
            const resultDiv = document.getElementById('storageResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.textContent = `âœ… å·²è®¾ç½®æµ‹è¯• Token\n\n${testToken}`;
        }

        // æµ‹è¯•è·¯ç”±è·³è½¬
        function testRouteNavigation() {
            const resultDiv = document.getElementById('routeResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ æœªæ‰¾åˆ° Tokenï¼Œæ— æ³•æµ‹è¯•è·¯ç”±è·³è½¬\n\nè¯·å…ˆç™»å½•æˆ–è®¾ç½®æµ‹è¯• Token';
                return;
            }

            resultDiv.textContent = 'æ­£åœ¨è·³è½¬åˆ° Dashboard...';
            
            setTimeout(() => {
                window.location.href = '/#/student/dashboard';
            }, 1000);
        }

        // ç›´æ¥è®¿é—® Dashboard
        function testDirectAccess() {
            window.location.href = '/#/student/dashboard';
        }

        // æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
        function showDiagnostics() {
            const resultDiv = document.getElementById('diagnosticsResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const diagnostics = {
                'å½“å‰ URL': window.location.href,
                'å½“å‰ Hash': window.location.hash,
                'Token çŠ¶æ€': localStorage.getItem('token') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                'Token é•¿åº¦': localStorage.getItem('token')?.length || 0,
                'æµè§ˆå™¨': navigator.userAgent,
                'localStorage å†…å®¹': Object.keys(localStorage).map(key => `${key}: ${localStorage.getItem(key)?.substring(0, 50)}...`).join('\n')
            };
            
            resultDiv.textContent = Object.entries(diagnostics)
                .map(([key, value]) => `${key}:\n${value}`)
                .join('\n\n');
        }
    </script>
</body>
</html>
